FROM ubuntu:25.10

# Install Java dependencies
RUN apt update -y && apt upgrade -y
RUN apt install -y gradle maven git libpcap-dev

RUN git clone https://github.com/CanadianInstituteForCybersecurity/CICFlowMeter /tool
RUN cd /tool/jnetpcap/linux/jnetpcap-1.4.r1425 && \
    mvn install:install-file \
        -Dfile=jnetpcap.jar -DgroupId=org.jnetpcap -DartifactId=jnetpcap \
        -Dversion=1.4.1 -Dpackaging=jar
WORKDIR /tool
RUN gradle --no-daemon build

# Build CICFlowMeter tool with custom gradle task
RUN cat > /gradle-task <<'GRADLETASK'
task runcmd(type: JavaExec){
    main = "cic.cs.unb.ca.ifm.Cmd"
    classpath = sourceSets.main.runtimeClasspath
    String osName = System.getProperty('os.name').toLowerCase()
    if(osName.contains('windows')){
        jvmArgs '-Djava.library.path=jnetpcap/win/jnetpcap-1.4.r1425'
    }else{
        jvmArgs '-Djava.library.path=jnetpcap/linux/jnetpcap-1.4.r1425'
    }
    args(cmdargs.split(":"))
}
GRADLETASK
RUN cat /gradle-task >>build.gradle && rm /gradle-task

# Copy the CICFlowMeter launcher script to the root directory
RUN cat > cicflowmeter.sh <<'LAUNCHER'
gradle --no-daemon -Pcmdargs=$1:$2 runcmd
LAUNCHER
RUN chmod 500 cicflowmeter.sh

# Install Python Dependencies
RUN apt install -y python3 python3-pip

WORKDIR /worker

# Install Python libraries
COPY requirements.txt ./
RUN pip3 install --no-cache-dir -r requirements.txt --break-system-packages

COPY ./*.py ./
CMD ["python3", "run_cicflowmeter.py"]
